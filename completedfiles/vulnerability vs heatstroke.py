import matplotlib.pyplot as plt
import pandas as pd
import numpy as np


path = "C:\\Users\\Lenovo\\Desktop\\Data\\Helix\\Round_2\\heat\\data"
filename = "health.csv"
df = pd.read_csv(path + "\\" + filename)


check = df.groupby("neighbourhood_id")["social_vulnerability_index"].nunique()
print("Max unique vulnerability values per neighbourhood:", check.max())

# Extract one value per neighbourhood
vulnerability_by_neighbour = df.groupby("neighbourhood_id", as_index=False).agg(
    {"social_vulnerability_index": "first"}
)

# -----------------------------
# 2️⃣ Create quartile groups at neighbourhood level
# -----------------------------

vulnerability_by_neighbour["vulnerability_group"] = pd.qcut(
    vulnerability_by_neighbour["social_vulnerability_index"],
    q=4,
    labels=["Low", "Medium-Low", "Medium-High", "High"],
)

# -----------------------------
# 3️⃣ Merge back to daily dataset
# -----------------------------

df = df.drop(columns=["vulnerability_group"], errors="ignore")

df = df.merge(
    vulnerability_by_neighbour[["neighbourhood_id", "vulnerability_group"]],
    on="neighbourhood_id",
    how="left",
)

# -----------------------------
# 4️⃣ Create GLOBAL temperature bins
# -----------------------------

df["temp_bin"] = pd.cut(df["avg_temp_lag5"], bins=25)

# -----------------------------
# 5️⃣ Plot curves
# -----------------------------

groups = ["Low", "Medium-Low", "Medium-High", "High"]

plt.figure(figsize=(9, 6))

for group in groups:

    df_group = df[df["vulnerability_group"] == group]

    binned = (
        df_group.groupby("temp_bin")
        .agg({"avg_temp_lag5": "mean", "heatstroke_deaths": "mean"})
        .dropna()
    )

    plt.plot(binned["avg_temp_lag5"], binned["heatstroke_deaths"], label=group)

plt.xlabel("5-Day Lag Average Temperature (°C)")
plt.ylabel("Mean Heatstroke Deaths")
plt.title("Lag-5 Temperature vs Heatstroke Deaths\nby Social Vulnerability Level")
plt.legend(title="Vulnerability")
plt.grid(alpha=0.3)

plt.tight_layout()
plt.show()
